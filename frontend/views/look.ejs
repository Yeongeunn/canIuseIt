<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>써도 되나?</title>
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/app.css">
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-xl">
      <a class="navbar-brand" href="/">
        <img src="/images/logo.png" alt="써도되나" title="써도되나">
      </a>
      <!-- 모바일 버전에서 상호작용 가능한 버튼. 마우스를 올리면 메인 메뉴 보임. -->
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse m-5" id="navbarSupportedContent">
        <ul class="navbar-nav mr-5 ml-auto">
          <li class="nav-item d-inline text-right">
            <a class="nav-link" href="/">제품 소비기한 조회</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="/look">내 제품 소비기한 한눈에 보기</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/label">라벨지 출력하기</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/calendar">캘린더 일정 확인하기</a>
          </li>
        </ul>
        <!-- 로그인 상태에 따라 로그인/로그아웃 버튼 표시 -->
        <% if (user) { %>
          <button class="btn btn-look" id="logoutButton">로그아웃</button>
          <% } else { %>
            <button class="btn btn-look" onClick="location.href='/login'">로그인</button>
            <% } %>
      </div>
    </div>
  </nav>

  <div class="look-image">
    <div class="look-text">
      <p class="h0 mb-0 mt-5 text-black font-weight-bolder text-center d-block">내 제품 소비기한 한 눈에 보기</p>
      <p class="h4 mt-3 mb-5 text-black text-center d-block">그동한 조회했던 제품들의 소비기한을 모아봤어요.</p>
    </div>
  </div>

  <!-- 카테고리 선택 드롭다운 메뉴와 정렬 드롭다운 메뉴 -->
  <div class="container-xl text-center mt-3 d-flex justify-content-center align-items-center">
    <select id="styleFilter" class="form-control" style="max-width: 300px; margin-right: 10px;">
      <option value="style1" selected>정렬 스타일1</option>
      <option value="style2">정렬 스타일2</option>
    </select>

    <select id="categoryFilter" class="form-control" style="max-width: 300px; margin-right: 10px;">
      <option value="">카테고리 선택</option>
      <option value="100">화장품</option>
      <option value="200">의약품</option>
      <option value="300">식품</option>
      <option value="400">기타</option>
    </select>

    <select id="sortFilter" class="form-control" style="max-width: 300px;">
      <option value="newest" selected>최신 등록순</option>
      <option value="expiry_soon">소비기한 임박순</option>
    </select>
  </div>


  <div class="container-xl mt-5 look">
    <% if (!user) { %>
      <div class="alert alert-warning" role="alert">
        로그인 후 이용해주세요.
      </div>
      <% } else if (products.length===0) { %>
        <div class="alert alert-info" role="alert">
          등록된 제품이 없습니다.
        </div>
        <% } else { %>
          <div id="productGrid" class="row">
            <% products.forEach((product, index)=> { %>
              <div class="col-md-4 col-sm-6 col-xs-12 mb-4 product-item" data-category="<%= product.categoryId %>"
                data-product-created="<%= product.created_at.toISOString() %>">
                <div class="card h-100">
                  <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center">
                      <p class="font-weight-bolder d-block h4 mb-0">
                        <%= product.alias %>
                      </p>
                      <a href="#" class="btn delete-product-btn" data-product-id="<%= product.productId %>"
                        style="background-color: #f28c91; color: white; padding: 0.25rem 0.5rem;">삭제</a>
                    </div>
                    <div class="product-image text-center mt-3" style="height: 200px;">
                      <% if (product.productImagePath) { %>
                        <img src="<%= product.productImagePath %>" alt="<%= product.alias %>" class="img-fluid"
                          style="max-height: 100%; max-width: 100%;">
                        <% } else { %>
                          <p class="text-muted">이미지 없음</p>
                          <% } %>
                    </div>
                    <div class="mt-auto">
                      <p class="d-block h5">소비기한: <%= product.expiry_date ?
                          product.expiry_date.toISOString().split('T')[0] : 'N/A' %>
                      </p>
                    </div>
                  </div>
                </div>
              </div>
              <% }) %>  <!-- forEach를 종료 -->
          </div>
          <% } %>  <!-- else 블록 종료 -->
        </div>




          <footer id="footer">
            <div class="container-xl">
              <div class="line mt-5"></div>
              <img src="/images/logo.png" class="mt-5" alt="">
              <img src="/images/sns.png" class="d-block mt-2 sns" alt="">
              <p class="text-dark">Copyright(c) 2024 써도 되나?. All rights reserved.</p>
            </div>
          </footer>
          <script>
            document.addEventListener('DOMContentLoaded', (event) => {
              const logoutButton = document.getElementById('logoutButton');
              if (logoutButton) {
                logoutButton.addEventListener('click', () => {
                  fetch('/auth/logout', {
                    method: 'GET',
                    credentials: 'include'
                  })
                    .then(response => {
                      if (response.redirected) {
                        window.location.href = response.url;
                      }
                    })
                    .catch(error => {
                      console.error('Logout error:', error);
                    });
                });
              }
            });

            /* 카테고리 선택에 따라 제품을 필터링 */
            document.getElementById('categoryFilter').addEventListener('change', function () {
              var selectedCategory = this.value;
              var products = document.querySelectorAll('.product-item');

              products.forEach(function (product) {
                var productCategory = product.getAttribute('data-category');

                // 화장품 카테고리 선택 시 100, 101, 102, 103 카테고리 모두 표시
                if (selectedCategory === "100") {
                  if (["100", "101", "102", "103"].includes(productCategory)) {
                    product.style.display = 'block';
                  } else {
                    product.style.display = 'none';
                  }
                } else if (selectedCategory === "" || productCategory === selectedCategory) {
                  product.style.display = 'block';
                } else {
                  product.style.display = 'none';
                }
              });
            });

            /* 제품 정렬 */
            // 최신 등록순으로 기본 정렬
            sortProducts('newest');

            // 정렬 선택시 정렬 변경
            document.getElementById('sortFilter').addEventListener('change', function () {
              sortProducts(this.value);
            });


            // 정렬 함수 정의
            function sortProducts(criteria) {
              var products = Array.from(document.querySelectorAll('.product-item'));

              products.sort(function (a, b) {
                var dateA, dateB;

                switch (criteria) {
                  case 'newest':
                    // 등록일을 기준으로 최신 순 정렬
                    dateA = new Date(a.getAttribute('data-product-created'));
                    dateB = new Date(b.getAttribute('data-product-created'));
                    return dateB - dateA;

                  case 'expiry_soon':
                    // 소비기한 임박순 정렬
                    dateA = new Date(a.querySelector('.h5').innerText.split('소비기한: ')[1]);
                    dateB = new Date(b.querySelector('.h5').innerText.split('소비기한: ')[1]);
                    return dateA - dateB;

                  default:
                    return 0;
                }
              });

              // 정렬된 제품을 DOM에 다시 추가
              var productGrid = document.getElementById('productGrid');
              productGrid.innerHTML = '';
              products.forEach(function (product) {
                productGrid.appendChild(product);
              });
            }

            // 레이아웃 스타일 변경 함수 정의
            function changeLayoutStyle(style) {
              var products = document.querySelectorAll('.product-item');

              if (style === 'style1') {
                // 기본 카드 스타일 유지
                products.forEach(function (product) {
                  product.classList.remove('style2-layout');
                  product.classList.add('col-md-4', 'col-sm-6', 'col-xs-12', 'mb-4');
                  product.querySelector('.card').classList.remove('style2-card');
                });
              } else if (style === 'style2') {
                // 사진과 같은 리스트 스타일로 변경
                products.forEach(function (product) {
                  product.classList.remove('col-md-4', 'col-sm-6', 'col-xs-12', 'mb-4');
                  product.classList.add('style2-layout'); // 새로운 레이아웃을 위한 클래스 추가
                  product.querySelector('.card').classList.add('style2-card');
                });
              }
            }


            /* 등록된 제품 삭제 */
            document.querySelectorAll('.delete-product-btn').forEach(button => {
              button.addEventListener('click', function (event) {
                event.preventDefault();

                const productId = this.getAttribute('data-product-id');

                if (confirm('정말 이 제품을 삭제하시겠습니까?')) {
                  fetch(`/api/products/delete-product/${productId}`, {
                    method: 'DELETE',
                    headers: {
                      'Content-Type': 'application/json'
                    }
                  })
                    .then(response => response.json())
                    .then(data => {
                      if (data.success) {
                        // 삭제가 성공하면 제품을 UI에서 제거
                        const productElement = this.closest('.product-item');
                        productElement.remove();
                        alert('제품이 삭제되었습니다.');
                      } else {
                        alert('제품 삭제에 실패했습니다.');
                      }
                    })
                    .catch(error => {
                      console.error('Error:', error);
                      alert('서버 오류가 발생했습니다. 다시 시도해주세요.');
                    });
                }
              });
            });


          </script>
</body>

</html>